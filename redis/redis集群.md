# 集群概述

主从和哨兵机制解决了高可用、高并发读的问题。但是仍然有两个问题没有解决
* 海量数据存储
* 高并发写

使用分片集群可以解决上述问题，**分片集群的特征**：
* 集群中有多个master，每个master保存不同数据
* 每个master都可以有多个slave节点
* master之间通过ping监控彼此的健康状态
* 客户端可以访问集群中任意节点，最终都会被转发到正确节点

**集群的作用**：
* 数据分区：集群将数据分散到多个节点，一方面能够突破单机内存大小限制，另一方面能够提高集群响应能力
* 高可用：集群支持主从复制和主节点的自动故障转移（类似哨兵机制）

# 实现原理

**数据分片实现原理**

Redis会把0~16383个插槽分配给不同的master节点。数据key不是与节点绑定，而是与插槽绑定。redis会根据key的有效部分计算插槽值：
* key中包含"{}"，且"{}"中至少包含一个字符，"{}"中的部分是有效部分
* key中不包含"{}"，这个key都是有效部分

**key与节点的映射过程**

1. 利用CRC16算法得到一个hash值，然后对16384取余得到的结果就是slot值
2. 根据slot与节点的映射关系得到 当前key所在的节点。


**双端口**

集群作为一个整体对外提供服务，集群中的节点之间会进行通信。集群中的每个节点提供两个TCP端口：
普通端口：对外提供服务的端口。
集群端口：端口号是普通端口+10000。集群端口用于节点之间的通信。在配置防火墙时需要同时开启普通端口和集群端口。

# 参考资料
[Scaling](https://redis.io/docs/management/scaling/)
[深入学习Redis（5）：集群](https://www.cnblogs.com/kismetv/p/9853040.html#t1)